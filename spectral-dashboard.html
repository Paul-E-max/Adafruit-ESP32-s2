<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spectral Test Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=JetBrains+Mono&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    :root {
      --bg-dark: #0a0b10;
      --card-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --primary: #00f2ff;
      --secondary: #7000ff;
      --text-main: #e0e0e0;
      --text-dim: #909090;
      --success: #00e676;
      --warning: #ffeb3b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: radial-gradient(circle at top right, #1a1b2e, #0a0b10);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 1.5rem;
      gap: 1.5rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 1rem;
    }

    .title h1 {
      font-size: 1.3rem;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .title p {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--glass-border);
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--primary);
      color: #000;
      border-color: var(--primary);
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 0.75rem;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
    }

    .btn.success {
      background: var(--success);
      color: #000;
      border: none;
    }

    .btn.small {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    .main {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 1.5rem;
      flex: 1;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 1.5rem;
      padding: 1.5rem;
    }

    .chart-area {
      display: flex;
      flex-direction: column;
    }

    .chart-area canvas {
      flex: 1;
      max-height: 350px;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--primary);
    }

    .live-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }

    .live-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.5rem;
      padding: 0.5rem;
      text-align: center;
    }

    .live-box .val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    .live-box .lbl {
      font-size: 0.6rem;
      color: var(--text-dim);
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .input-group input {
      flex: 1;
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-family: inherit;
    }

    .test-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .test-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .test-item .name {
      font-weight: 600;
    }

    .test-item .peak {
      font-size: 0.75rem;
      color: var(--warning);
      font-family: 'JetBrains Mono', monospace;
    }

    .test-item .actions {
      display: flex;
      gap: 0.25rem;
    }

    .actions button {
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .hidden {
      display: none !important;
    }

    /* Report Viewer */
    .report-view {
      display: none;
      margin-top: 1rem;
    }

    .report-view.active {
      display: block;
    }

    .reports-stack {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .report-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 1.5rem;
      padding: 1.5rem;
      border-top: 4px solid var(--primary);
      position: relative;
    }

    .report-card.color-0 {
      border-top-color: #00f2ff;
    }

    .report-card.color-1 {
      border-top-color: #7000ff;
    }

    .report-card.color-2 {
      border-top-color: #00e676;
    }


    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .report-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
    }

    .report-meta {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .report-content {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 1.5rem;
    }

    .report-chart-container {
      height: 300px;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
    }

    .report-table th {
      text-align: left;
      color: var(--text-dim);
      padding-bottom: 0.5rem;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--glass-border);
    }

    .report-table td {
      padding: 0.5rem 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .btn-close {
      background: rgba(255, 0, 0, 0.2);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-close:hover {
      background: rgba(255, 0, 0, 0.4);
    }

    .import-bar {
      display: flex;
      justify-content: center;
      padding: 2rem;
      border: 2px dashed var(--glass-border);
      border-radius: 1rem;
      margin-bottom: 2rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .import-bar:hover {
      border-color: var(--primary);
      background: rgba(0, 242, 255, 0.05);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 230, 118, 0.9);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s;
      pointer-events: none;
      z-index: 1000;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.error {
      background: rgba(255, 0, 0, 0.9);
    }
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>
  <div class="app">
    <header class="header">
      <div class="title">
        <h1>Spectral Test Lab</h1>
        <p>Light Source Analysis & Recording</p>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="live">Live Test</button>
        <button class="tab" data-tab="report">Report Viewer</button>
      </div>
      <button id="connectBtn" class="btn primary">Connect</button>
    </header>

    <!-- LIVE TEST VIEW -->
    <main class="main" id="liveView">
      <div style="display:flex; flex-direction:column; gap:1.5rem; min-width:0;">
        <div class="card chart-area">
          <div class="section-title">Spectral Analysis (AS7341)</div>
          <canvas id="spectralChart"></canvas>
          <div style="margin-top:1rem; display:flex; gap:1rem; align-items:center;">
            <span style="color:var(--text-dim)">Peak:</span>
            <span id="livePeak" style="font-family:'JetBrains Mono';font-size:1.2rem;color:var(--warning)">--</span>
          </div>
        </div>
        <div class="card chart-area">
          <div class="section-title">Broadband Analysis (TSL2591)</div>
          <canvas id="tslChart"></canvas>
        </div>
        <div class="card chart-area">
          <div class="section-title">UV Intensity (LTR390)</div>
          <canvas id="uvChart"></canvas>
        </div>
      </div>
      <aside class="sidebar">
        <div class="card">
          <div class="section-title">Live Readings</div>
          <div class="live-grid">
            <div class="live-box"><span class="val" id="lF1">0</span><span class="lbl">F1</span></div>
            <div class="live-box"><span class="val" id="lF2">0</span><span class="lbl">F2</span></div>
            <div class="live-box"><span class="val" id="lF3">0</span><span class="lbl">F3</span></div>
            <div class="live-box"><span class="val" id="lF4">0</span><span class="lbl">F4</span></div>
            <div class="live-box"><span class="val" id="lF5">0</span><span class="lbl">F5</span></div>
            <div class="live-box"><span class="val" id="lF6">0</span><span class="lbl">F6</span></div>
            <div class="live-box"><span class="val" id="lF7">0</span><span class="lbl">F7</span></div>
            <div class="live-box"><span class="val" id="lF8">0</span><span class="lbl">F8</span></div>
          </div>
          <div style="margin-top:0.75rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
            <div class="live-box" style="flex:1; min-width: 60px;"><span class="val" id="lUV">0</span><span
                class="lbl">UV</span></div>
            <div class="live-box" style="flex:1; min-width: 60px;"><span class="val" id="lALS">0</span><span
                class="lbl">ALS</span></div>
            <div class="live-box" style="flex:1; min-width: 60px;"><span class="val" id="lLux">0</span><span
                class="lbl">Lux</span></div>
            <div class="live-box" style="flex:1; min-width: 60px;"><span class="val" id="lIR">0</span><span
                class="lbl">IR (Counts)</span></div>
            <div class="live-box" style="flex:1; min-width: 60px;"><span class="val" id="lFull">0</span><span
                class="lbl">Full (Counts)</span></div>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Record Test</div>
          <div class="input-group">
            <input type="text" id="testName" placeholder="Light source name...">
            <button id="recordBtn" class="btn success small">Record</button>
          </div>
          <div id="recordStatus" style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.75rem;"></div>
          <div class="section-title">Saved Tests (<span id="testCount">0</span>/7)</div>
          <div class="test-list" id="testList"></div>
        </div>
        <div class="card">
          <div class="section-title">File Actions</div>
          <button id="exportBtn" class="btn small" style="width:100%">Export Records to JSON</button>
          <button id="clearBtn" class="btn small"
            style="width:100%; margin-top:0.5rem; background:rgba(255,0,0,0.2)">Clear All</button>
        </div>
      </aside>
    </main>

    <!-- REPORT VIEWER -->
    <div class="report-view" id="reportView">
      <div style="display:flex; justify-content:center; gap:1rem; margin-bottom:2rem;">
        <div class="import-bar" onclick="document.getElementById('importFile').click()"
          style="margin-bottom:0; flex:1;">
          <span style="color:var(--primary); font-weight:600;">+ Import Comparison Report (JSON)</span>
          <input type="file" id="importFile" accept=".json" style="display:none">
        </div>
        <button id="toggleDetailsBtn" class="btn" onclick="toggleDetails()" style="width:200px;">Show Full
          Measurements</button>
      </div>
      <div id="reportsStack" class="reports-stack"></div>
    </div>
  </div>

  <script>
    // Register Plugin
    Chart.register(ChartDataLabels);

    // Constants & Utils
    const WAVELENGTHS = { F1: 415, F2: 445, F3: 480, F4: 515, F5: 555, F6: 590, F7: 630, F8: 680 };
    // Updated Colors: 415(Violet), 445(Blue), 480(Cyan), 515(Green), 555(Lime), 590(Orange), 630(Red), 680(Deep Red)
    const COLORS = ['#7600bc', '#1f24d3', '#00d4ff', '#00cc00', '#aaff00', '#ffcc00', '#ff0000', '#990000'];

    // Toast Notification
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.className = 'toast', 3000);
    }

    // State
    let liveTests = [];
    let recording = false;
    let samples = [];
    let importedReports = [];
    let nextReportId = 1;
    let port, reader, connected = false;

    // Live Chart
    const liveCtx = document.getElementById('spectralChart').getContext('2d');
    const liveChart = new Chart(liveCtx, {
      type: 'bar',
      data: { labels: Object.keys(WAVELENGTHS).map(k => WAVELENGTHS[k] + 'nm'), datasets: [{ data: [0, 0, 0, 0, 0, 0, 0, 0], backgroundColor: COLORS, borderRadius: 6 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            color: '#fff',
            anchor: 'end',
            align: 'top',
            offset: 4,
            font: { size: 10, weight: 'bold' },
            formatter: (v) => v > 0 ? v : ''
          }
        },
        scales: {
          y: { beginAtZero: true, grace: '20%', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#909090' } },
          x: { grid: { display: false }, ticks: { color: '#909090' } }
        }
      }
    });

    // TSL Chart
    const tslCtx = document.getElementById('tslChart').getContext('2d');
    const tslChart = new Chart(tslCtx, {
      type: 'bar',
      data: {
        labels: ['Full Spectrum', 'Infrared'],
        datasets: [{
          data: [0, 0],
          backgroundColor: ['#ffffff', '#ff4444'],
          borderRadius: 6,
          barPercentage: 0.5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            color: '#fff',
            anchor: 'end',
            align: 'top',
            offset: 4,
            font: { size: 10, weight: 'bold' },
            formatter: (v) => v.toFixed(0)
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grace: '20%',
            title: { display: true, text: 'Raw Counts', color: '#909090' },
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#909090' }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#909090' }
          }
        }
      }
    });

    // UV Chart
    const uvCtx = document.getElementById('uvChart').getContext('2d');
    const uvChart = new Chart(uvCtx, {
      type: 'line',
      data: {
        labels: Array(50).fill(''),
        datasets: [{
          label: 'UV Intensity',
          data: Array(50).fill(0),
          borderColor: '#00f2ff',
          backgroundColor: 'rgba(0, 242, 255, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            color: '#000',
            backgroundColor: '#00f2ff',
            borderRadius: 4,
            padding: 4,
            align: 'top',
            anchor: 'center',
            offset: 8,
            font: { size: 12, weight: 'bold' },
            // Show label on the peak value in the current dataset
            display: function (context) {
              const data = context.dataset.data;
              const val = data[context.dataIndex];
              const max = Math.max(...data);
              return val === max && max > 0 && context.dataIndex === data.lastIndexOf(max);
            },
            formatter: (val) => 'PEAK UV: ' + val
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grace: '10%',
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#909090' }
          },
          x: {
            display: false
          }
        }
      }
    });

    function detectPeak(data) {
      const vals = [data.F1, data.F2, data.F3, data.F4, data.F5, data.F6, data.F7, data.F8];
      const maxIdx = vals.indexOf(Math.max(...vals));
      const keys = Object.keys(WAVELENGTHS);
      return { channel: keys[maxIdx], wavelength: WAVELENGTHS[keys[maxIdx]] };
    }

    // Live Updates
    function updateLiveUI(d) {
      liveChart.data.datasets[0].data = [d.F1, d.F2, d.F3, d.F4, d.F5, d.F6, d.F7, d.F8];
      liveChart.update('none');

      tslChart.data.datasets[0].data = [d.TSL_Full || 0, d.TSL_IR || 0];
      tslChart.update('none');

      // UV Update
      uvChart.data.datasets[0].data.push(d.UV || 0);
      uvChart.data.datasets[0].data.shift();
      uvChart.update('none');

      ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8'].forEach(k => document.getElementById('l' + k).textContent = d[k] || 0);
      document.getElementById('lUV').textContent = d.UV || 0;
      document.getElementById('lALS').textContent = d.ALS || 0;
      document.getElementById('lLux').textContent = (d.TSL_Lux || 0).toFixed(1);
      document.getElementById('lIR').textContent = d.TSL_IR || 0;
      document.getElementById('lFull').textContent = d.TSL_Full || 0;
      const peak = detectPeak(d);
      document.getElementById('livePeak').textContent = peak.wavelength + 'nm (' + peak.channel + ')';
    }

    function renderLiveTests() {
      const list = document.getElementById('testList');
      list.innerHTML = liveTests.map((t, i) => `
        <div class="test-item">
          <div><span class="name">${t.name}</span><br><span class="peak">Peak: ${t.peak.wavelength}nm</span></div>
          <div class="actions"><button class="btn small" onclick="deleteLiveTest(${i})">✕</button></div>
        </div>
      `).join('');
      document.getElementById('testCount').textContent = liveTests.length;
    }

    function deleteLiveTest(i) { liveTests.splice(i, 1); renderLiveTests(); }

    // Recording Logic
    document.getElementById('recordBtn').onclick = () => {
      if (recording) {
        recording = false;
        document.getElementById('recordBtn').textContent = 'Record';
        if (samples.length > 0) {
          const avg = {};
          ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'UV', 'ALS', 'TSL_Lux', 'TSL_IR', 'TSL_Full'].forEach(k => avg[k] = Math.round(samples.reduce((s, d) => s + (d[k] || 0), 0) / samples.length));
          avg.name = document.getElementById('testName').value || 'Test ' + (liveTests.length + 1);
          avg.peak = detectPeak(avg);
          avg.timestamp = new Date().toISOString();
          liveTests.push(avg);
          renderLiveTests();
          document.getElementById('testName').value = '';
        }
        document.getElementById('recordStatus').textContent = '';
        samples = [];
      } else {
        recording = true;
        samples = [];
        document.getElementById('recordBtn').textContent = 'Stop';
        document.getElementById('recordStatus').textContent = 'Recording...';
      }
    };

    // Export & Clear
    document.getElementById('exportBtn').onclick = () => {
      const report = { version: 1, exportedAt: new Date().toISOString(), tests: liveTests };
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'spectral-report.json'; a.click();
    };
    document.getElementById('clearBtn').onclick = () => { if (confirm('Clear all recorded tests?')) { liveTests = []; renderLiveTests(); } };

    // --- STACKED REPORT VIEWER ---

    let showFullDetails = false;

    document.getElementById('importFile').onchange = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const fr = new FileReader();
      fr.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.tests) {
            data.id = nextReportId++;
            data.filename = file.name;
            importedReports.push(data);
            renderStackedReports();
          }
        } catch { alert('Invalid JSON file'); }
      };
      fr.readAsText(file);
      e.target.value = ''; // Reset input
    };

    function toggleDetails() {
      showFullDetails = !showFullDetails;
      const btn = document.getElementById('toggleDetailsBtn');
      if (btn) {
        btn.textContent = showFullDetails ? 'Hide Full Measurements' : 'Show Full Measurements';
        btn.classList.toggle('primary');
      }
      renderStackedReports();
    }

    function renderStackedReports() {
      const container = document.getElementById('reportsStack');
      container.innerHTML = '';

      importedReports.forEach((report, idx) => {
        const div = document.createElement('div');
        div.className = 'report-card color-' + (idx % 3);

        let headerCols = '<th>Test Name</th><th>Peak</th><th>Lux</th>';
        if (showFullDetails) headerCols += '<th>F1</th><th>F2</th><th>F3</th><th>F4</th><th>F5</th><th>F6</th><th>F7</th><th>F8</th><th>UV</th><th>ALS</th><th>IR</th><th>Full</th>';

        div.innerHTML = `
          <div class="report-header">
            <div>
              <div class="report-title">${report.filename}</div>
              <div class="report-meta">Parsed: ${new Date().toLocaleTimeString()} • ${report.tests.length} Tests</div>
            </div>
            <button class="btn-close" onclick="removeReport(${report.id})">✕</button>
          </div>
          <div class="report-content">
            <div class="report-chart-container">
              <canvas id="chart-${report.id}"></canvas>
            </div>
            <div style="overflow-y:auto; max-height:300px; ${showFullDetails ? 'grid-column: span 2;' : ''}">
              <table class="report-table">
                <thead><tr>${headerCols}</tr></thead>
                <tbody>
                  ${report.tests.map(t => {
          let row = `
                      <td style="font-weight:600">${t.name}</td>
                      <td style="color:${t.peak.wavelength > 550 ? '#ffeb3b' : '#00f2ff'}">${t.peak.wavelength}nm</td>
                      <td>${t.TSL_Lux.toFixed(0)}</td>
                    `;
          if (showFullDetails) {
            row += `
                        <td>${t.F1}</td><td>${t.F2}</td><td>${t.F3}</td><td>${t.F4}</td>
                        <td>${t.F5}</td><td>${t.F6}</td><td>${t.F7}</td><td>${t.F8}</td>
                        <td>${t.UV}</td><td>${t.ALS}</td><td>${t.TSL_IR || 0}</td><td>${t.TSL_Full || 0}</td>
                      `;
          }
          return `<tr>${row}</tr>`;
        }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
        container.appendChild(div);

        // Render Chart for this report
        const ctx = document.getElementById(`chart-${report.id}`).getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: report.tests.map(t => t.name), // X-axis: Test names
            datasets: [
              {
                label: 'Peak Wavelength (nm)',
                data: report.tests.map(t => t.peak.wavelength),
                backgroundColor: 'rgba(0, 242, 255, 0.5)',
                yAxisID: 'y'
              },
              {
                label: 'Luminosity (Lux)',
                data: report.tests.map(t => t.TSL_Lux),
                backgroundColor: 'rgba(112, 0, 255, 0.5)',
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#e0e0e0' } },
              datalabels: {
                color: (context) => context.dataset.yAxisID === 'y' ? '#00f2ff' : '#7000ff',
                anchor: 'end',
                align: 'top',
                offset: 2,
                font: { size: 9, weight: 'bold' },
                formatter: (v, context) => {
                  return context.dataset.yAxisID === 'y' ? v + 'nm' : v.toFixed(0);
                }
              }
            },
            scales: {
              y: { type: 'linear', position: 'left', grace: '20%', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#00f2ff' } },
              y1: { type: 'linear', position: 'right', grace: '20%', grid: { display: false }, ticks: { color: '#7000ff' } },
              x: { grid: { display: false }, ticks: { color: '#909090' } }
            }
          }
        });
      });
    }

    window.removeReport = (id) => {
      importedReports = importedReports.filter(r => r.id !== id);
      renderStackedReports();
    };

    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('liveView').style.display = tab.dataset.tab === 'live' ? 'grid' : 'none';
        document.getElementById('reportView').classList.toggle('active', tab.dataset.tab === 'report');
      };
    });

    // Serial Connection
    document.getElementById('connectBtn').onclick = async () => {
      if (connected) { await disconnect(); return; }
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        connected = true;
        document.getElementById('connectBtn').textContent = 'Disconnect';
        document.getElementById('connectBtn').classList.remove('primary');
        showToast('✓ Connected to COM port');
        readLoop();
      } catch (e) {
        showToast('Connection failed: ' + e.message, true);
      }
    };

    async function disconnect() {
      try {
        if (reader) {
          await reader.cancel();
          reader.releaseLock();
        }
        if (port) await port.close();
        connected = false;
        document.getElementById('connectBtn').textContent = 'Connect';
        document.getElementById('connectBtn').classList.add('primary');
        showToast('✓ Disconnected successfully');
        console.log('✓ Disconnected successfully');
      } catch (e) {
        console.error('Disconnect error:', e);
        // Force disconnect state even if error
        connected = false;
        document.getElementById('connectBtn').textContent = 'Connect';
        document.getElementById('connectBtn').classList.add('primary');
      }
    }

    async function readLoop() {
      const decoder = new TextDecoderStream();
      port.readable.pipeTo(decoder.writable);
      reader = decoder.readable.getReader();
      let buffer = '';
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += value;
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete chunk
          for (const line of lines) {
            try {
              const d = JSON.parse(line.trim());
              // Accept data if F1 (AS7341) OR TSL_Lux (TSL2591) is present
              if (d.F1 !== undefined || d.TSL_Lux !== undefined) {
                updateLiveUI(d);
                if (recording) samples.push(d);
              }
            } catch { }
          }
        }
      } catch { }
    }
  </script>
</body>

</html>